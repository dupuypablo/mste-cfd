\documentclass{CFD2011}
\usepackage{CFD2011}

%\usepackage[normalem]{ulem}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%This template is created for complying with the author instructions for the 
%8th International Conference on CFD in Oil & Gas, Metallurgical and Process Industries
%hosted by SINTEF/NTNU, Trondheim Norway
%21-23 June 2011
%
%Sverre G. Johnsen (sverre.g.johnsen@sintef.no)
%SINTEF Materials and Chemistry


%Required files:
%   ExampleFile.tex
%   xampleFile.nls
%   CFD2011.bst
%   CFD2011.cls
%   CFD2011.sty
%   References.bib

%Example-specific files:
%   figure.eps
%   Table.tex
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%




\title{Application of the least-squares method to the multiscale transport equation in porous media}
\paperID{CFD11-52}
\author{Federico}{Sporleder} %{forename}{surname}
%\presenting  %the previous author is presenting the paper (name becomes underlined)
\address{NTNU Department of Chemical Engineering, 7491 Trondheim, NORWAY}%affiliation of the previous author
\email{federico.sporleder@nt.ntnu.no}%e-mail address of the previous author
\author{Pablo}{M. Dupuy}
\presenting
\address{CSIRO Mathematics, Informatics and Statistics, 3169 Clayton South VIC, Australia}
\email{pablo.dupuy@csiro.au}
%\author{Sverre}{G. Johnsen}
%\address{SINTEF Materials and Chemistry, 7465 Trondheim, NORWAY}
%\email{sverre.g.johnsen@sintef.no}

\newcommand{\TODO}[1]{\textcolor{blue}{TODO: #1} \\}
\newcommand{\Fede}[1]{\textcolor{green}{Fede: #1} \\}
\newcommand{\Pablo}[1]{#1}
\newcommand{\newf}[1]{#1}
\newcommand{\nof}[1]{\textcolor{cyan}{}}
%\newcommand{\nof}[1]{\textcolor{cyan}{{\sout{#1}}}}

\begin{document}
\maketitle  %create the title page
\headers   %create the page headers and footers

\abstract{
During the last two decades characterization capabilities of porous media have been transformed by advances on computation and visualization technologies.  
It is now possible to obtain a fairly good visualization of the microstructure by computer tomographies. Discrete, diffusion or fluid flow simulations can be run in these domains obtaining traditional experimental characterization parameters. However, the characterization itself has not suffered a significant change because our models have not been updated. On this regard, new models are needed to achieve better up-scaling. A multi-scale approach for up-scaling renders into a model that keeps track of different phenomena happening at different scales and that is coupled in all scales simultaneously imposing great challenges for the solution method. In this work we study the suitability of a high-order least-square method for the solution of a multi-scale transport equation for porous media. Our results show that the method is particularly well suited for the solution of the equation that models 1D transport with reactions 
depending strongly on the scale, even in the presence of a multi-scale coupling term.
}
\keywords{
  Chemical reactions, pore size distribution, LSQ
}
\normalfont\normalsize



%\section{Nomenclature}
%the nomenclature needs to be entered into the file ExampleFile.nls
\printnomenclature[0.7cm]  
\vskip .1em

\section{Introduction}
Theories for studying porous media were first formulated as early \newf{as }the end of the eighteen century\newf{,} after the volume fraction concept was introduced for describing mud. Half a century later\newf{,} one of the most basic law\newf{s} for saturated porous solids was established by Henry Darcy, i.e. the flow velocity of the liquid in a porous solid is proportional to the pressure gradient. Since then\newf{, increasingly} more complex theories for predicting the proportionality constant \newf{have arised}, incorporating the capillary force and considering deformable media with the definition of the consolidation problem \citep{Boer1992}. 

Studies on the water-soil characteristic curve \citep{durner1994}, experimental characterization techniques such as gas adsorption or mercury porosimetry \citep{Navas,Jaroniec1997,Abell1999}\nof{(nitrogen adsorption and mercury)}\newf{,} and the popularization of pore networks \citep{zhang1994, held2001, oren2002, blunt2002, piri2005, ahrenholz2008, sholokhova2009} have \nof{solidify}\newf{consolidated} the concept of coexisting \nof{different-size }pores\nof{, better represented as the} \newf{of different sizes, which can be better represented with a} pore size distribution, e.g. see \cite{dullien1991}.

Indeed, there are many different phenomena that will be affected by the pore size, as for example the physical principles of any of the experimental methods mentioned before. At the same time, heterogeneous reactions and the pore hydraulic resistivity are expected to depend strongly with the pore size. Therefore there is a clear need for adopting models that are able to capture and use the information on the pore size distribution in an efficient way.

The multi-scale transport equation for porous media (MSTE) was proposed as an extension of approaches considering a finite number of groups \citep{Chen1989, bouffard2001}. One internal coordinate was recently introduced \citep{DupuySchwarz} to the continuity problem for accounting the multi-scale transport of species and the scale-dependent physics. Furthermore, the MSTE defines an inter-pore redistribution function $h$ that makes the equation open and requires further research to find the most adequate closure or model.

However, the incorporation of one internal coordinate to the transport equation introduces one extra dimension in complexity. Not only all the main variables\nof{,} depend now on the pore scale, but \newf{also }the partial differential equation system \nof{is now}\newf{becomes} an integro-partial differential equation system. This brings problems at the time of choosing the most suitable solution method. 

\nof{Many other phenomena in nature can be described by an integro-differential equation with one or many internal coordinates. The Boltzmann transport equation has the molecule velocity as an internal coordinate. The transport equation applied to neutrons or its condensation into the diffusion equation for neutrons use the neutron energy as internal energy. Population balance problems use the particle, bubble or droplet size as internal coordinate. The least square method has been applied succesfully to population balance problems by cite{Dorao05a}.}

%Many other phenomena in nature can be described by an integro-differential equation with one or many internal coordinates. The Boltzmann transport equation \newf{\cite{Chapman1970} }has the molecule velocity as an internal coordinate. The transport equation applied to neutrons \newf{\cite{Duderstad1976} }or its condensation into the diffusion equation for neutrons use the neutron energy\nof{as internal energy}. Population balance problems use \nof{the particle, bubble or droplet size}\newf{a property of the entities} as internal coordinate \newf{\cite{Ramkrishna2000}}. \nof{The least square method has been applied succesfully to population balance problems by cite{Dorao05a}.}\newf{Several numerical methods have been developed accordingly, most of which are thought to eliminate the integral terms from the equations.}

\newf{Several numerical methods have been developed for solving integro--differential equations in other areas of science. Examples are the neutron transport equation \cite{Duderstadt1976} and the population balance equation \cite{Ramkrishna2000}. Most of these methods are designed to eliminate the integral terms from the equations.}
\newf{In recent years, the work by \cite{Dorao05a}, \cite{Patruno2010} and \cite{Sporleder2011} has shown the capability of the least-squares method (LSQ) to solve the integro-differential form of the equations directly. This spectral method is based on the idea that under certain conditions minimizing the residual of the equations defined with the numerical solution is equivalent to minimizing the error, i.e., the distance between the numerical solution and the exact solution \cite{Jiang1998}. This reformulation of the equations as a minimization problem is independent of the equations at hand, and therefore it allows for flexible and general--purpose programming. Besides, the method uses a measure of the residual as a built-in error estimator, and presents semi-analytical solutions, as the minimizing function is expanded in a family of basis functions. When combined with the finite or spectral element approach \cite{Gerritsma2010}, it is capable of solving large problems in arbitrary geometries, using unstructured meshes.}

The scope of the present work \nof{does not allow us to address}\newf{leaves aside} how to find \nof{any of }the kernels of the MSTE \nof{nor any comparison}\newf{as well as possible comparisons} with experiments. \nof{We are interested in the study of the suitability of the LSQ method for the solution of the MSTE for porous media, and this will be achieved by the manufactured solution method. We will only focus here in the steady state case, in one dimension only.}\newf{Instead, we focus on the suitability of the LSQ to solve the MSTE. The analysis will make use of the manufactured solution method for a one-dimensional steady--state case. The extension to more complex problems is straight--forward.}

The objective of this paper is to propose \nof{and explain how to use} \newf{the }LSQ for the solution of the \nof{multi-scale transport equation}\newf{MSTE} for porous media \newf{and explain its implementation}. The \nof{multi-scale transport}\newf{model}, the solution method and \nof{a}\newf{the} numerical example are given in the following three sections.

\section{Model}

Traditionally, the transport of a given species with concentration $\phi$ convected by plug flow through a porous media without diffusion in one dimension (z) can be written as:

\begin{equation}
\epsilon v \frac{\partial \phi(z)}{\partial z}=S(z)
\end{equation}

\noindent where $v$ is the advective velocity, $\epsilon$ is the void (or fluid) porosity and the right hand side is a source term. However, this approach is not able to capture all the degrees of freedom present in real porous media and the two-porosity model has been a successful first extension towards a more scale-size-related approach. Recently, a multi-scale approach has been introduced as a generalization to this concept based on the pore scale \cite{DupuySchwarz}.

The term \nof{pore-size have}\newf{pore size has} been used loosely in the literature and needs to be addressed first. \newf{In our framework, it is a characteristic length that represents the pore scale. } Some authors \cite{dullien1991} proposed \nof{to use}\newf{to define the pore size as} twice the hydraulic radius\nof{as a convenient definition but others might work as well in the present approach since what we are after is a characteristic length that will represent the pore scale}. \nof{Any of these choices requires a proper definition of a pore as a unity, for which any arbitrary definition of a portion of the void volume can chosen where a pore size can be measure (e.g. hydraulic radius) for each pore.}\newf{Other definitions may be used. Regardless of the choice, a consitent definition of a pore as a unity is required.} Most pore networks agree on the definition of these elementary units. Each pore will therefore have a volume. In the MSTE, all the void volume is assigned to pores, and the concept of throat \citep{oren2002, blunt2002, piri2005} is not needed\newf{. This is different to} \nof{making a difference with }some pore network strategies. 

%\Fede{Lo cambi\'e bastante porque no se entend\'ia, perd\'on. Si falta algo, ponga nom\'as...}
%\Fede{Qu\'e es throat? Pore networks? Capaz alguna ref? Y si estas diferencias con otros m\'etodos establecidos las ponemos en la intro?}

\nof{Let's}\newf{Let us} define $\xi$ as the pore size, and $\epsilon(\xi)d\xi$ \newf{as the total volume of the pores} \nof{the summed volume for all the pores }of sizes between $\xi$ and $\xi+d\xi$ per volume unit.
\nof{On average, the permeability will be different for each pore size as well, $k(\xi)$. A driven force will produce an advective velocity of the fluid at the scale $\xi$ denoted as $v(\xi)$, and the discharge (or slip velocity) for the same scale is $q(\xi)=\epsilon(\xi) v(\xi)$.}
\newf{We will indicate the permeability of a pore of size $\xi$ with $k(\xi)$, the advective velocity of the fluid at the scale $\xi$ as $v(\xi)$, and the discharge (or slip velocity) for the same scale as $q(\xi)=\epsilon(\xi) v(\xi)$}.

% \Fede{De nuevo cambio, pero me pareci\'o que la intenci\'on era definir variables. Igual, no est\'a muy claro. Se nota que no estoy en tema. Pero m\'as all\'a de eso, te puedo preguntar si $\epsilon$ y $q$ son distribuciones o no (hasta ahora no, m\'as adelante s\'i), y a $\phi$ nunca la introduc\'is tampoco (s\'e que es el tracer, pero exactamente c\'omo se define??).}

%\Fede{Capaz podr\'ias empezar definiendo $\phi$ y el problema f\'isico, poner la ecuaci\'on, describir los t\'erminos y las variables que aparecen claramente, y despu\'es las otras como $\epsilon$, que en la ecuaci\'on no figuran directamente... Te va as\'i? Esta secci\'on es cr\'itica, porque el modelo es muy muy poco conocido.}
% \Fede{Dejo de corregir la secci\'on. Me gustar\'ia de ser posible que ac\'a hagas una intro al modelo general, y el 1D introducirlo despu\'es, como simplificaci\'on... }

Recent works \cite{DupuySchwarz} introduced the concept of the redistribution function $h(\xi_1 \rightarrow \xi_2)$ as the discharge from pores of size $\xi_1$ into pores of sizes $\xi_2$. This is a measure of the mixing between pores of different scales.

The $\epsilon(\xi)d\xi$ and $q(\xi)d\xi$ are the probability density functions for porosity and discharge. Their definition is sometimes clarified by defining the cumulative distribution function, $F_{\epsilon}(\xi)=\int_0^{\xi}\epsilon(\hat \xi)d\hat\xi$ and $F_{q}(\xi)=\int_0^{\xi}q(\hat\xi)d\hat\xi$. $F_{\epsilon}(\xi)$ is dimensionless and represents the porosity of a solid media obtained by considering all the pores of size smaller or equal to $\xi$.

The multi-scale transport for a tracer in all the pores assuming one dimension ($z$) and steady state case can be written as \citep{DupuySchwarz}:

\begin{align}
\nonumber q(z, \xi) \cdot \frac{\partial \phi(z, \xi)}{\partial z}  &= S(z, \xi)   +
 \int [\phi(z, \hat \xi) - \phi(z, \xi)] h(z, \hat \xi \rightarrow \xi) d\hat \xi\\
\phi(z=z_{\Gamma},\xi)&=\phi_{\Gamma}(\xi).
\label{eq:ss2}
\end{align}

With $\phi_{\Gamma}(\xi)$ a boundary condition.
The left hand side and first term of the right hand side of the equation \ref{eq:ss2} are the convection per scale and the source per scale and present no major interaction between scales. However, the integral on the right hand side couples different scales and makes impossible to solve the problem for each scale independently. It should be pointed out that advection can be happening at different speeds ($\tfrac{\partial q}{\partial \xi} \neq 0$) and the source term can also be written independently for each pore-size.

%\TODO{    * Point out challenges for solving the equation}

\section{The least-squares method}
\label{sec:LSQ}
The LSQ reformulates any given well-posed set of equations as a minimization problem. As the MSTE could be taken as part of a more complex model, we present the method in a general manner, for a non-linear set of equations. 

Let us write the problem to be solved as follows: 

Find $\mathbf{f}\in X(\Omega)$ such that:
\begin{eqnarray}
\mathcal{L} \mathbf{f} = \mathbf{g} \quad \mbox{in} \ \Omega \label{eq:Problem} \\
\mathcal{B} \mathbf{f} = \mathbf{f}_{\Gamma} \quad \mbox{on} \ \Gamma \label{eq:Boundary}
\end{eqnarray}

\noindent where $\Omega$ is the domain of the system, $\Gamma$ is the boundary of the domain, $\mathcal{L}$ is a functional operator, and $\mathcal{B}$ is the trace operator. $\mathbf{f}$ is the approximating function, which in the ideal case coincides with the exact solution to the problem.

Equation \ref{eq:Boundary} represents the equations of the boundary conditions, while  equation \ref{eq:Problem} represents the main equations of the problem. 
For example, taking equation \ref{eq:ss2} we find:

\begin{eqnarray}
\mathbf{f}&=&\phi_i \nonumber \\
\mathbf{g}&=&S_i \label{eq:problem} \\
\mathcal{L}\bullet&=& q \cdot \frac{\partial \bullet}{\partial z} - \int \bullet h(z, \hat \xi \rightarrow \xi) d\hat \xi +\bullet\int h(z, \hat \xi \rightarrow \xi) d\hat \xi \nonumber\\
\mathcal{B}\bullet&=&  \bullet
 \nonumber
\end{eqnarray}

\Pablo{A} norm equivalent functional \Pablo{can} defined as follows:

\begin{eqnarray} 
\mathcal{J}(\mathbf{f})\equiv  \frac{1}{2}\parallel \mathcal{L} \mathbf{f} -\mathbf{g} \parallel_{Y(\Omega)}^2 + \frac{1}{2} \parallel \mathcal{B}\mathbf{f} - \mathbf{f}_{\Gamma} \parallel_{Y(\Gamma)}^2. 
\label{eq:WeakLSQ}
\end{eqnarray}

\Pablo{The functional $\mathcal{J}(\mathbf{f})$} is a measure of the residual of an aproximating function $\mathbf{f}\in X(\Omega)$. If the approximating function is the exact solution, the functional becomes zero.
The residual of the boundary equations is included in equation \ref{eq:WeakLSQ} to allow a weak imposition of the boundary conditions. That is, we allow the use of spaces $X(\Omega)$ that are not constrained to satisfy these conditions. 

%\Fede{Te saqu\'e un aporte, no te ofendas :-)}

It is assumed that the problem is well-posed and that the operators $\mathcal{L}$ and $\mathcal{B}$ conform a continuous mapping of the function space $X(\Omega)\times X(\Gamma)$ on the space $Y(\Omega) \times Y(\Gamma)$. Under these conditions, a norm equivalence between the norm of the residual and the norm of the error is established. That is, finding a function $\mathbf{f}\in X(\Omega)$ that minimizes the functional $\mathcal{J}(\mathbf{f})$ is equivalent to finding the approximating function in $X(\Omega)$ which is closest to the exact solution to the problem. 

%\Pablo{Yo lo entiendo porque yo se LSQ (algo al menos)... pero no se como se explica mejor realmente... $\mathbf{f}$ es la solucion o es la aproximacion a la solucion? equacion 2 es inconsistente con el resto... o no? Es una muy poco feliz decision elegir el mismo symbolo para ambas, o no? Debido a que en nuestro problema la solucion es $\phi$ decidi hacer el cambio en la definicion del problema. Luego usamos $\mathbf{f}$ para la aprox solo.  Agregue un texto que capaz ayuda para aclarar ese punto.}
%\Fede{Yo tampoco s\'e c\'omo explicarlo mejor, jeje. Es lo m\'as simplificado que puedo hacerlo, sin mandar fruta for export y sin ir en contra de los fundamentos matem\'aticos. Hice cambios basados en tus comentarios, y creo que ahora queda mejor. Pero sig aceptando sugerencias. No tengo forma f\'acil de explicar el espacio Y. Est\'a definido impl\'icitamente en el problema, es el espacio im\'agen del mapeo que hace el operador. }

Therefore, the least squares method is based on finding an $\mathbf{f} \in X(\Omega)$ such that this functional is minimized. The reader is refered to \cite{Bochev2009} for more details on the mathematical formalism. 
%
%The spectral element method of the least squares type consists in sub-dividing the computational domain $\Omega$ into $N_e$ non--overlapping sub--domains $\Omega_e$, called spectral elements. We then look for the minimizing function within each spectral element $\mathbf{f}_P^e \in X_P(\Omega_e) \subset X(\Omega_e)$ such that:
%
%\begin{eqnarray}
%\mathbf{f}_P^e&=&\sum_{j=0}^{N_p-1} \mathbf{b}_j^e \varphi_j^e \label{eq:suma} \\
%\mathbf{f}_P&=&\bigcup _{e=1}^{N_e}\mathbf{f}_P^e
%\end{eqnarray}
%
%\noindent where $\mathbf{b}_j^e$ are the coefficients of the expansion for the spectral element $e$. 

\subsection{Solution procedure}

%\Pablo{No he leido esta seccion todavia en mucho detalle. Pero parece estar bien. Si es la primera vez que se publica este tipo de informacion decime que agarro la lupa y la miro en mas detalle... se la podes dar a Hugo a ver si la entiende, jeje }
%\Fede{Hugo se duerme en estas secciones. Dice que ya lo conoce, despu\'es me viene a preguntar 3 veces por semana cosas que explico justamente en estas secciones... Tengo un paper aceptado que muestra esto en casi igual :-)}
Using variational analysis, minimizing the functional $\mathcal{J}(\mathbf{f})$ is equivalent to finding $\mathbf{f} \in X(\Omega)$ such that:

\begin{eqnarray}
\lim_{\epsilon \to 0} \frac{d}{d\epsilon}{\mathcal{J}(\mathbf{f}+\epsilon \ \mathbf{w})}=0 && \forall \mathbf{w} \in X(\Omega)
\label{eq:minimization}
\end{eqnarray}

\noindent where $X(\Omega)$ is the space of admissible functions.

We use the $L^2$ norm defined as $\parallel \bullet  \parallel_{Y(\Omega)}^2= \langle \bullet, \bullet \rangle= \int_\Omega  \bullet \bullet   \ d\Omega$ for simplicity. Using $\mathcal{E} {(}\mathbf{f} {)}=\mathcal{L}\mathbf{f}-\mathbf{g}$ to represent the equations, we express the norm equivalent functional as:

\begin{equation}
\mathcal{J}(\mathbf{f})\equiv  \frac{1}{2} \langle \mathcal{E} {(}\mathbf{f} {)},\mathcal{E} {(}\mathbf{f} {)} \rangle
\end{equation}

Here, we leave aside the equations for the boundary conditions. The extension of the solution procedure to these is straight-forward. 

In practice, we restrict the search of the minimizing function to a finite--dimensional function space such that $\mathbf{f}_P \in X_P(\Omega) \subset X(\Omega)$ and $X_P(\Omega)= span\{ \varphi_0,...,\varphi_P \} $:

\begin{eqnarray}
\mathbf{f}_P^e&=&\sum_{j=0}^{N_p-1} \mathbf{b}_j^e \varphi_j^e \label{eq:suma} \\
\mathbf{f}_P&=&\bigcup _{e=1}^{N_e}\mathbf{f}_P^e
\end{eqnarray}


Equation \ref{eq:minimization} yields then the equivalent problem: find $\mathbf{f_P} \in X_P(\Omega)$ such that:

\begin{equation}
\big\langle \frac{\partial\mathcal{E}}{\partial \mathbf{f}}\mathbf{w} , \mathcal{E}(\mathbf{f_P}) \big\rangle=\mathcal{G}=0 \ ,\ \ \forall \mathbf{w}\in X_P(\Omega)
\end{equation}


Here, $\frac{\partial\mathcal{E}}{\partial \mathbf{f}}$ is the operator obtained by dividing the different equations by the different variables. It can be divided in rows which represent each equation, and in columns which represent the operator affecting each variable in each equation. That is,

\begin{eqnarray}
\mathbf{f}=\left[ \begin{array}{ccccc} f_1 & ... & f_{v} & ... & f_{N_v} \end{array} \right]^T \nonumber\\
 {\mathcal{E}} {\frac{\partial\mathcal{E}}{\partial \mathbf{f}}}=\left[ \begin{array}{ccccc}
 {\frac{\partial\mathcal{E}_{1}}{\partial \mathbf{f_1}}} & ... &  {\frac{\partial\mathcal{E}_{1}}{\partial \mathbf{f_v}}} & ... &  {\frac{\partial\mathcal{E}_{1}}{\partial \mathbf{f_{N_v}}}} \\
... & ... & ... & ... & ... \\
 {\frac{\partial\mathcal{E}_{c}}{\partial \mathbf{f_{1}}}} & ... &  {\frac{\partial\mathcal{E}_{c}}{\partial \mathbf{f_{v}}}} & ... &  {\frac{\partial\mathcal{E}_{c}}{\partial \mathbf{f_{N_v}}}} \\
... & ... & ... & ... & ... \\
 {\frac{\partial\mathcal{E}_{N_c}}{\partial \mathbf{f_{1}}}} & ... &  {\frac{\partial\mathcal{E}_{N_c}}{\partial \mathbf{f_{v}}}} & ... &  {\frac{\partial\mathcal{E}_{N_c}}{\partial \mathbf{f_{N_v}}}} \\
\end{array} \right] 
\label{eq:eqOp}
\end{eqnarray}

\noindent where $N_v$ is the number of variables and $N_c$ is the number of equations.

For linear problems, $\frac{\partial\mathcal{E}}{\partial \mathbf{f}}\mathbf{w}=\mathcal{L}\mathbf{w}$, and the problem is reduced to finding $\mathbf{f_P} \in X_P(\Omega)$ such that:


\begin{eqnarray}
\mathcal{A}(\mathbf{f_P},\mathbf{w})=\mathcal{F}(\mathbf{w}) \ ,\ \forall \mathbf{w} \ \in X_P(\Omega)
\label{eq:equivalent}
\end{eqnarray}

\noindent where

\begin{eqnarray}
\mathcal{A}(\mathbf{f},\mathbf{w})= \langle \mathcal{L}\mathbf{f},\mathcal{L}\mathbf{w} \rangle \nonumber \\ 
\mathcal{F}(\mathbf{w})= \langle \mathbf{g},\mathcal{L}\mathbf{w} \rangle 
\label{eq:equivLinear}
\end{eqnarray}




For non-linear problems, a seed solution $\mathbf{f^*_P}$ is proposed, and the Newton-Raphson method is used to iterate until the minimizing solution is found. This method is based on the expansion in Taylor series of $\mathcal{G}$ around $\mathbf{f^*_P}$, and yields the following equivalent problem: find $\delta\mathbf{f_P}=\mathbf{f_P}-\mathbf{f^*_P} \in X_P(\Omega)$ such that:

\begin{eqnarray}
\big\langle \frac{\partial}{\partial \mathbf{f}} \left(\frac{\partial\mathcal{E}}{\partial \mathbf{f}}\mathbf{w}\right)^*\mathbf{\delta f_P} , \mathcal{E}(\mathbf{f^*_P}) \big\rangle  \nonumber \\
+\big\langle \frac{\partial \mathcal{E}}{\partial \mathbf{f}}^*\mathbf{\delta f_P} , \frac{\partial \mathcal{E}}{\partial \mathbf{f}}^*\mathbf{w} \big\rangle +
\big\langle \mathcal{E}(\mathbf{f^*_P}) , \frac{\partial \mathcal{E}}{\partial \mathbf{f}}^*\mathbf{w} \big\rangle =0 \ ,\ \mathbf{w} \ \in X_P(\Omega)
\end{eqnarray}

The first term is usually set to zero \cite{Winterscheidt1994, Codd2001}. This term is dominated by the others near the solution. Furthermore, the absence of this term simplifies greatly the computation and does not affect the method, only the way in which the solution is looked for.

The equivalent problem to be solved is to find $\mathbf{f_P} \in X_P(\Omega)$ such that equation \ref{eq:equivalent} is fulfilled, with:


\begin{eqnarray}
\mathcal{A}(\mathbf{f},\mathbf{w})= \big\langle \frac{\partial \mathcal{E}}{\partial \mathbf{f}}^*\mathbf{f} ,  \frac{\partial \mathcal{E}}{\partial \mathbf{f}}^*\mathbf{w} \big\rangle \nonumber \\
\mathcal{F}(\mathbf{w})= \big\langle \frac{\partial \mathcal{E}}{\partial \mathbf{f}}^*\mathbf{f^*}-\mathcal{E}(\mathbf{f^*}) , \frac{\partial \mathcal{E}}{\partial \mathbf{f}}^*\mathbf{w} \big\rangle 
\label{eq:equivNR}
\end{eqnarray}

%\begin{equation}
%\big\langle \frac{\partial \mathcal{E}}{\partial \mathbf{f}}|_0\mathbf{f} ,  \frac{\partial \mathcal{E}}{\partial \mathbf{f}}|_0\mathbf{w} \big\rangle =
%\big\langle \frac{\partial \mathcal{E}}{\partial \mathbf{f}}|_0\mathbf{f_0}-\mathcal{E}\mathbf{f_0} , \frac{\partial \mathcal{E}}{\partial \mathbf{f}}|_0\mathbf{w} \big\rangle\ \ , \ \forall \mathbf{w} \in X(\Omega)
%\end{equation}

Comparing equation \ref{eq:equivNR} to equation \ref{eq:equivLinear}, this procedure is equivalent to linearizing the equations using the Newton-Raphson method and then applying the least-squares method to the resulting linear problem $ \frac{\partial \mathcal{E}}{\partial \mathbf{f}}^*\mathbf{f}=\frac{\partial \mathcal{E}}{\partial \mathbf{f}}^*\mathbf{f^*}-\mathcal{E}(\mathbf{f^*})$. The Picard method (also known as fixed point or direct substitution method) has also been used to linearize the equations \cite{Sporleder2010}.

The algebraic set of equations corresponding to the equivalent problem is found expanding the approximate solution (equation \ref{eq:suma}). The internal products are approximated numerically using quadrature rules. Thus, the system of algebraic equations is given as follows:

\begin{equation}
\mathbf{A} \mathbf{b} = \mathbf{F}
\end{equation}

\noindent where $\mathbf{b}$ is the vector of coefficients of the expansion in equation \ref{eq:suma}, and where:

\begin{eqnarray}
\mathbf{A}=\mathbf{L}^T\mathbf{W}\mathbf{L} \nonumber \\
\mathbf{F}=\mathbf{L}^T\mathbf{W}\mathbf{G} \nonumber
\end{eqnarray}

$\mathbf{L}$ is called the problem operator matrix, $\mathbf{W}$ is a diagonal matrix built with the quadrature weights and $\mathbf{G}$ is called source vector. The three can be subdivided analogously to equation \ref{eq:eqOp}:

\begin{eqnarray}
\mathbf{G}=\left[ \begin{array}{ccccc} G_1 & ... & G_{c} & ... & G_{N_c} \end{array} \right]^T \nonumber\\
\mathbf{L}=\left[ \begin{array}{ccccc}
L_{11} & ... & L_{1v} & ... & L_{1N_v} \\
... & ... & ... & ... & ... \\
L_{c1} & ... & L_{cv} & ... & L_{cN_v} \\
... & ... & ... & ... & ... \\
L_{N_c1} & ... & L_{N_cv} & ... & L_{N_cN_v} \\
\end{array} \right] 
\end{eqnarray}

\noindent where:

\begin{eqnarray}
\left[L_{cv}\right]_{qk}&=&\left(\frac{\partial \mathcal{E}_c}{\partial \mathbf{f}}\right)^*_v \varphi_k (\mathbf{r_q}) \nonumber \\
\left[G_{c}\right]_{q}&=&\frac{\partial \mathcal{E}_c}{\partial \mathbf{f}}^*\mathbf{f_P^*}(\mathbf{r_q})-\mathcal{E}_c(\mathbf{f_P^*}(\mathbf{r_q}))
\end{eqnarray}

Here, $\mathbf{r_q}$ is the quadrature point $q$.

\section{Numerical example}
%We rewrite the problem equation \ref{eq:ss2} as,
%
%\begin{eqnarray}
%q(z,\psi)\frac{\partial \phi(z,\xi)}{dz} +\phi(z,\xi)\int h(z,\xi\rightarrow\hat{\xi})d\hat{\xi} \nonumber \\
%-\int \phi(z,\hat{\xi}) h(z,\xi\rightarrow\hat{\xi})d\hat{\xi} = S(z,\xi)
%\end{eqnarray}
%
%The equation is linear when solved for $\phi(z,\xi)$. Thus, $\frac{\partial \mathcal{E}}{\partial \phi}\bullet=\mathcal{L}\bullet=q(z,\psi)\frac{\partial \bullet}{dz} +\int h(z,\xi\rightarrow\hat{\xi})d\hat{\xi}\bullet -\int h(z,\xi\rightarrow\hat{\xi})\bullet d\hat{\xi}$. 
As shown in equation \ref{eq:problem}, the MSTE is linear when solved for $\phi(z,\xi)$. 
The equation presents a derivative, an identity and an integral operator applied to $\phi$. In matricial form:

\begin{eqnarray}
\mathbf{L}&=&\mathbf{C_1}\mathbf{Dz}+\mathbf{C_2}\mathbf{H} \Pablo{+} \mathbf{I_h} \\
\mathbf{G}&=&\mathbf{S}
\end{eqnarray}

\noindent with:

\begin{eqnarray}
\left[\mathbf{C_1}\right]_{qj}&=& \delta_{qj}q(z_q,\xi_q) \nonumber \\
\left[\mathbf{C_2}\right]_{qj}&=& \delta_{qj}\int h(z_q,\xi_q\rightarrow\hat{\xi})d\hat{\xi} \nonumber \\
\left[\mathbf{S}\right]_{q}&=& S(z_q,\xi_q) \nonumber 
\end{eqnarray}

\noindent where $\delta_{qj}$ is the Kronecker delta. The other matrices, namely $\mathbf{D_z}$, $\mathbf{H}$, and $\mathbf{I_h}$ are called operator matrices.


$\mathbf{D_z}$ is called the derivative operator matrix in z, and is defined as follows:

\begin{equation}
\left[\mathbf{D_z}\right]_{qj}=\frac{\partial \varphi_j}{\partial z}(z_q,\xi_q)
\end{equation}

$\mathbf{H}$ is the identity operator matrix, and is defined as follows:

\begin{equation}
\left[\mathbf{H}\right]_{qj}=\varphi_j(z_q,\xi_q)
\end{equation}

$\mathbf{I_h}$ is the integral operator weighted with $h$, and is defined as follows:

\begin{eqnarray}
\left[\mathbf{I_h}\right]_{qj}&=& \Pablo{-} \int h(z_q,\xi_q\rightarrow\hat{\xi})\varphi_j(z_q,\hat{\xi}) d\hat{\xi}\nonumber \\
&=& \Pablo{-} \sum_k h(\xi_q\rightarrow s_k )\varphi_j(z_q,s_k) \omega_k
\end{eqnarray}

Here, we define new quadrature points and weights such that $s_k$ exists within the integration boundaries for each row of the integral operator matrix. 

%\Fede{Si el problema a resolver ya se introdujo en la segunda secci\'on, entonces esto de ac\'a puede ir a la secci\'on de implementaci\'on :-)}


We select the case of flow through a column for our numerical example. A one meter column filled with a packed bed of rocks has a porosity per scale given by $\epsilon({\xi})$. Liquid is introduced from the top which percoles down the column at a given discharge per scale given by $q({\xi})$. The pore-scale redistribution, $h$  is assumed proportional to the discharges.

In the manufacturing solution method we propose a solution $\phi(\xi, z)$ and calculate analitically the value of the source. For this problem the chosen values are:

\begin{align}
\epsilon(\xi)=&A (\xi-\xi_0) (-\xi+\xi_f) \\
q({\xi}) =&V \epsilon(\xi) \xi^2\\
h(z, \hat \xi \rightarrow \xi) =& q(\hat \xi) q(\xi)/L\\
\phi(z, \xi) =& 10 sin(z) (1-M Log({\xi}/R))\\
\nonumber S(z, \xi)=& 10 A V cos(z) {\xi}^2 ({\xi}-\xi_0) (\xi_f-{\xi}) \left(1-M \text{Log}\left[\nicefrac{{\xi}}{R}\right]\right) +\\
\nonumber  &A^2 M V^2  (360 L)^{-1} {\xi}^2 ({\xi}-\xi_0) ({\xi}-\xi_f) sin(z) \times ... \\
\nonumber  &\big(-81 \xi_0^5+175 \xi_0^4 \xi_f-175 \xi_0 \xi_f^4+  ...\\
\nonumber &81 \xi_f^5+60 \xi_0^4 (3 \xi_0-5 \xi_f) \text{Log}\left[\frac{\xi_0}{{\xi}}\right]+ ...\\
& 60 (5 \xi_0-3 \xi_f) \xi_f^4 \text{Log}\left[\frac{\xi_f}{{\xi}}\right]\big)
\end{align}

\noindent \newf{with $A=\nicefrac{1}{500}~\text{mm}^{-3}$, $V=0.001 \nicefrac{\text{m}}{\text{mm}^2 \text{s}}$, $M=1$, $R=2\xi_f$, $L=10^{-5}~\nicefrac{\text{m}^2}{\text{s}}$ and pore scale limits $\xi_0=1$ mm and $\xi_f=10$ mm.}

\subsection{Results}
The Gauss--Lobatto--Legendre quadrature rule was used to approximate the integrals in $z$, while the Gauss--Legendre quadratures were used for $\xi$. The solution was approximated using a nodal expansion based on Lagrange polynomials defined at the zeros of these quadratures. The problem was coded in {MATLAB}, and its direct solver was used for the calculations.

%\TODO{Explain and show q, epsilon and h. and BCs}

Both the discharge, $q({\xi})$ and the porosity, $\epsilon({\xi})$ do not depend on the position along the column. Plot of the distribution and cumulative distribution for these two functions are given in Figure \ref{fig:profiles}.

\InsFig{profiles}{Left column: porosity distribution (top) and cumulative porosity distribution (bottom). Middle column: discharge distribution (top) and cumulative discharge distribution (bottom). Right column: velocity per channel (top), and 1-metre residence time (bottom)}{profiles}

%\TODO{Describe what case could be described with this simplified model.}

The solution is shown in Figure \ref{fig:solution}. As the liquid flows down the column $\phi$ increases due to reactions happening inside the pores. Despite the source term is very different for different pore sizes (negative for large pores and positive for small pores, see Figure \ref{fig:source}) the tracer $\phi$ is exchanged between different pores scales tending to level out the differences. However the increase is larger for the small pores at all the length of the column (z values). The source term (Figure \ref{fig:source}) behaves differently for different pore scales. Large amounts of $\phi$ are generated for pores smaller than 5 mm, while a sink is observed in the largest pores. This behaviour for the source term mimic two competing reactions. It models the case of a species that is a product of an heterogeneous reaction but is a reactant of a reaction taking place in the liquid bulk. Heterogeneous reactions depend strongly of the surface to volume ratio which is much larger for small pore scales. At the same time the reactant is consumed in the larger pores in this case as the bulk reaction that consumes $\phi$ becomes more dominant.

\InsFig{solution}{Solution $\phi(z,\xi)$.}{solution}

\InsFig{source}{Source term $S(z,\xi)$. }{source}

%\TODO{Explain what is happening with phi and S in each scale, and the mixing by h.}

%\TODO{Show and comment on convergence plot}
%Finally, the polynomial order for both dimensions was varied from 5 to 12 to verify if the numerical solution approximates to the proposed analytical solution. The infinity norm error is shown in the Figure \ref{fig:convergence} where it can be seen that the error is reduced exponentially with the method order up to computer precision. 
Finally, the polynomial order for both dimensions was varied from 5 to 12 to analyze the accuracy of the numerical solution. Figure \ref{fig:convergence} shows the $L^2$ norm of the error. It can be seen that the error is reduced with an exponential convergence rate. This follows the behavior of the norm of the residual, due to the norm equivalence mentioned when presenting the LSQ. The norm of the residual, shown in Figure \ref{fig:res}, decreases until reaching a point of limiting accuracy, close to numerical precision. The existance of norm equivalence provides the numerical method with a built-in error estimator. In finite and spectral element versions of the method, the norm of the residual can be used to design hp-adaptivity strategies that optimize the grid used.


\InsFig{convergence}{$L^2$ norm of the error vs. order of the approximation}{convergence}
\InsFig{res}{$L^2$ norm of the residual vs. order of the approximation}{res}

For completeness, the condition number versus the order of the approximation is shown in Figure \ref{fig:cond}. This number increases steeply with the order, reaching values over $10^{12}$. The condition number depends mostly on the fill-up of the matrix. The use of an element approach will reduce drastically this number. Larger models that use the MSTE are also expected to have lower condition numbers.

\InsFig{cond}{Condition number vs. order of the approximation}{cond}

\section{Conclusion}

The conclusions of this paper are:

\begin{itemize}
\item The \nof{least square high order method}\newf{LSQ} is well suited for the solution of the multi-scale transport equation for porous media\newf{,} achieving exponential convergence in the method order.
\item A method has been described and can now be applied for the solution of transport and reactions problems in porous media.
\end{itemize}

The combination of the MSTE with LSQ enables a set of new physics that now can be modelled. We have shown how the specific discharge, and therefore, the advecting velocity can be different at different scales, having travelling times between the smallest and the largest pore scales that vary two order of mangitude. The cumulative distribution function of any variable, such as the tracer concentration can be recovered at any point of the domain. Furthermore, having a source term that works as sink and as source depending on the pore scale is also possible enabling the modelling of the competition between heterogeneous rections and reactions occuring in the liquid bulk. Finally, the incorporation of a redistribution tems add the complexity of an integral term that binds physics happening at different scale loosing the locality behavior proper of a normal transport equation and still this can be fully captured by the LSQ also with exponential convergency.

Future work still remains on the area of finding the most adequate kernels that best represent different porous media. Mainly empirical studies of the redistribution function need to be done.
%\Fede{Ahora me tengo que ir, pero hay que mejorar esta conclusi\'on}
%\TODO{Conclusiones en serio?}
%\TODO{Bibliograf\'ia!!}
%\abstract{
%  This file is an example \LaTeX file for submission to CFD2011.  A
%  limit of 10 pages applies.
%}
%\keywords{
%  CFD, hydrodynamics, chemical reactors
%}
%\normalfont\normalsize
%
%
%
%%\section{Nomenclature}
%A complete list of symbols used, with dimensions, is required.
%%the nomenclature needs to be entered into the file ExampleFile.nls
%\printnomenclature[0.7cm]  
%\vskip .1em
%
%
%\section{Introduction}
%The introduction goes here.
%
%
%\newpage
%
%
%
%\section{Model Description}
%You should give a thorough description of your model.
%\vspace{4cm}
%\subsection{Example of Subheading}
%Here is how to produce a numbered equation under a second level
%heading \cite{James1988}.
%\vspace{2cm}\\
%\emph{Continuity equation}
%\begin{equation}
%  \frac{\partial \rho_G}{\partial t}+\nabla\left(\rho_G\mathbf
%    u\right)=0
%\end{equation}
%
%\subsubsection*{Example of Sub-subheading}
%This is how \cite{Luke1988} produced an unnumbered equation under a
%third level heading.
%\begin{equation}
%  \mathbf J=\sigma(\mathbf E+\mathbf u\times\mathbf B)
%\end{equation}
%\newpage
%

%\InsFig{figure}{Schematic diagram of geometry.}{label1}
%\InsFigRot{figure}{Rotated schematic diagram of geometry.}{label2}
%
%
%\section{Results}
%The results of using the \LaTeX template is a great looking paper.
%In Figures \ref{fig:label1} and \ref{fig:label2} it can be seen how figures are easily included.
%In Table \ref{tab:label} it is seen how we can include a table.
%The table is constructed in the file table.tex, where also the table caption and label are defined.
%
%
%\newpage
%\InsTab{Table}
%
%
%\section{Conclusion}
%The conclusions are:
%\begin{enumerate}
%  \item Trondheim is a nice city.
%  \item CFD is great fun, and useful too.
%\end{enumerate}
%
\newpage
%
%
%% %---------------------------
%% %BIBLIOGRAPHY
%% %---------------------------
%The bibliography is created using BiBTeX
\bibliographystyle{CFD2011}
\bibliography{MSTE}


%\newpage
%\section{Appendix A}
%List of animation files:
%s10.avi Motion of the spherical particles.
%v10.mped Flow field around each particle.


\end{document}